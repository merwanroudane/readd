# -*- coding: utf-8 -*-
"""
ุงูููุตุฉ ุงูุดุงููุฉ ูุดุฑุญ ุงูููุงูุงุช ุงูุฃุตููุฉ ูุงูุงุฎุชุจุงุฑุงุช ูู ุงูููุงุณ ุงูุงูุชุตุงุฏู
ุชุตููู: ุงูุฏูุชูุฑ ูุฑูุงู ุฑูุฏุงู
"""

import streamlit as st
from google import genai
from google.genai import types
import tempfile
import os
from datetime import datetime
from docx import Document as DocxDocument
from docx.shared import Inches, Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml.ns import qn
from docx.oxml import OxmlElement
import io

# ุชูููู ุงูุตูุญุฉ
st.set_page_config(
    page_title="ุงูููุตุฉ ุงูุดุงููุฉ - ุงูููุงุณ ุงูุงูุชุตุงุฏู",
    page_icon="๐",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS ููุฃููุงู ุงูุฏุงูุฆุฉ ูุงูุชุตููู ุงูุงุญุชุฑุงูู
st.markdown("""
<style>
    /* ุงูุฎูููุฉ ุงูุฑุฆูุณูุฉ - ุฃููุงู ุฏุงูุฆุฉ ูุงุชุญุฉ */
    .stApp {
        background: linear-gradient(135deg, #FFFBF5 0%, #FFF8F0 50%, #FFF5EB 100%);
    }
    
    /* ========== ููู ุงูุดุฑูุท ุงูุฌุงูุจู ุฅูู ุงููููู ========== */
    /* ุนูุณ ุงุชุฌุงู ุงูุชุทุจูู ุจุงููุงูู */
    [data-testid="stAppViewContainer"] {
        direction: rtl;
    }
    
    /* ุฅุนุงุฏุฉ ุงูุงุชุฌุงู ูููุญุชูู ุงูุฏุงุฎูู */
    [data-testid="stAppViewContainer"] > * {
        direction: ltr;
    }
    
    /* ุฅุนุงุฏุฉ ุงูุงุชุฌุงู ููุดุฑูุท ุงูุฌุงูุจู */
    [data-testid="stSidebar"] {
        direction: ltr;
    }
    
    /* ุฎูููุฉ ุงูุดุฑูุท ุงูุฌุงูุจู */
    [data-testid="stSidebar"] > div:first-child {
        background: linear-gradient(180deg, #FF9F6B 0%, #FF8C5A 100%) !important;
    }
    
    section[data-testid="stSidebar"] {
        background: linear-gradient(180deg, #FF9F6B 0%, #FF8C5A 100%) !important;
    }
    
    /* ========== ุฅุตูุงุญ ุฌููุน ุงูุนูุงุตุฑ ุงูุจูุถุงุก ูู ุงูุดุฑูุท ุงูุฌุงูุจู ========== */
    
    /* ุฅุฒุงูุฉ ุงูุฎูููุฉ ุงูุจูุถุงุก ูู ุฌููุน ุงูุนูุงุตุฑ */
    [data-testid="stSidebar"] div,
    [data-testid="stSidebar"] section,
    [data-testid="stSidebar"] [data-testid="stVerticalBlock"],
    [data-testid="stSidebar"] [data-testid="stVerticalBlockBorderWrapper"] {
        background-color: transparent !important;
        background: transparent !important;
    }
    
    /* ุงููุต ุฃุจูุถ */
    [data-testid="stSidebar"] * {
        color: white !important;
    }
    
    [data-testid="stSidebar"] .stTextInput label,
    [data-testid="stSidebar"] .stFileUploader label,
    [data-testid="stSidebar"] label {
        color: white !important;
        font-weight: bold;
    }
    
    /* ========== ุญูู ุฅุฏุฎุงู API ========== */
    [data-testid="stSidebar"] input[type="password"],
    [data-testid="stSidebar"] input[type="text"],
    [data-testid="stSidebar"] .stTextInput input {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        border: 2px solid rgba(255, 255, 255, 0.4) !important;
        border-radius: 8px !important;
    }
    
    [data-testid="stSidebar"] input::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    /* ========== ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ========== */
    [data-testid="stSidebar"] [data-baseweb="select"] {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border: 2px solid rgba(255, 255, 255, 0.4) !important;
        border-radius: 8px !important;
    }
    
    [data-testid="stSidebar"] [data-baseweb="select"] > div {
        background-color: transparent !important;
    }
    
    [data-testid="stSidebar"] .stSelectbox span,
    [data-testid="stSidebar"] [data-baseweb="select"] span {
        color: white !important;
    }
    
    /* ========== ููุทูุฉ ุฑูุน ุงููููุงุช - ุฅุตูุงุญ ุงูููู ุงูุฃุจูุถ ========== */
    [data-testid="stSidebar"] [data-testid="stFileUploader"],
    [data-testid="stSidebar"] [data-testid="stFileUploader"] > div,
    [data-testid="stSidebar"] [data-testid="stFileUploader"] section,
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzone"],
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzoneInstructions"],
    [data-testid="stSidebar"] .uploadedFile {
        background-color: rgba(255, 255, 255, 0.15) !important;
        background: rgba(255, 255, 255, 0.15) !important;
        border-color: rgba(255, 255, 255, 0.4) !important;
    }
    
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzone"] {
        border: 2px dashed rgba(255, 255, 255, 0.5) !important;
        border-radius: 12px !important;
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* ุฅุตูุงุญ ุงูุตูุฏูู ุงูุฃุจูุถ ุฏุงุฎู ุฑุงูุน ุงููููุงุช */
    [data-testid="stSidebar"] [data-testid="stFileUploader"] > div > div,
    [data-testid="stSidebar"] .stFileUploader > div > div,
    [data-testid="stSidebar"] [data-testid="stFileUploader"] [data-testid="stMarkdownContainer"],
    [data-testid="stSidebar"] [data-testid="stFileUploader"] small,
    [data-testid="stSidebar"] [data-testid="stFileUploader"] p {
        background: transparent !important;
        background-color: transparent !important;
    }
    
    /* ุงูููุทูุฉ ุงูุฏุงุฎููุฉ ุงูุจูุถุงุก */
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzoneInstructions"] > div,
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzoneInstructions"] > div > div {
        background: transparent !important;
        background-color: transparent !important;
    }
    
    /* ุฃู div ุจุฎูููุฉ ุจูุถุงุก */
    [data-testid="stSidebar"] div[style*="background-color: white"],
    [data-testid="stSidebar"] div[style*="background: white"],
    [data-testid="stSidebar"] div[style*="background-color: rgb(255, 255, 255)"],
    [data-testid="stSidebar"] div[style*="background: rgb(255, 255, 255)"] {
        background: transparent !important;
        background-color: transparent !important;
    }
    
    /* ุฒุฑ Browse files */
    [data-testid="stSidebar"] [data-testid="stFileUploaderDropzone"] button,
    [data-testid="stSidebar"] [data-testid="baseButton-secondary"] {
        background-color: rgba(255, 255, 255, 0.25) !important;
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        color: white !important;
    }
    
    /* ุงููููุงุช ุงููุฑููุนุฉ */
    [data-testid="stSidebar"] [data-testid="stFileUploaderFile"],
    [data-testid="stSidebar"] .uploadedFileData {
        background: rgba(255, 255, 255, 0.2) !important;
        border-radius: 8px !important;
    }
    
    /* ========== Expander (ุงููููุงุช ุงููุฑููุนุฉ) ========== */
    [data-testid="stSidebar"] [data-testid="stExpander"],
    [data-testid="stSidebar"] details,
    [data-testid="stSidebar"] summary {
        background: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 10px !important;
    }
    
    [data-testid="stSidebar"] details > div {
        background: transparent !important;
    }
    
    /* ========== ุฎูุงุฑุงุช ุงููุงุฆูุฉ ุงูููุณุฏูุฉ (Dropdown) ========== */
    [data-baseweb="popover"],
    [data-baseweb="menu"] {
        direction: rtl;
    }
    
    [data-baseweb="popover"] li,
    [data-baseweb="menu"] li {
        text-align: right !important;
        color: #333 !important;
    }
    
    /* ========== ุงูุนูุงููู ========== */
    h1 {
        color: #E07B39 !important;
        text-align: center;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    h2, h3 {
        color: #D4703A !important;
        text-align: right;
        direction: rtl;
    }
    
    /* ========== RTL ูููุต ุงูุนุฑุจู ูู ุงููุญุชูู ุงูุฑุฆูุณู ========== */
    .main p, 
    .main div,
    .main span,
    .main li,
    .main h1, .main h2, .main h3, .main h4, .main h5, .main h6,
    [data-testid="stMarkdownContainer"] p,
    [data-testid="stMarkdownContainer"] div,
    [data-testid="stMarkdownContainer"] span,
    [data-testid="stMarkdownContainer"] li,
    [data-testid="stMarkdownContainer"] h1,
    [data-testid="stMarkdownContainer"] h2,
    [data-testid="stMarkdownContainer"] h3,
    [data-testid="stMarkdownContainer"] h4,
    [data-testid="stMarkdownContainer"] ul,
    [data-testid="stMarkdownContainer"] ol {
        direction: rtl !important;
        text-align: right !important;
        unicode-bidi: plaintext;
    }
    
    /* ุงูููุงุฆู */
    .main ul, .main ol,
    [data-testid="stMarkdownContainer"] ul,
    [data-testid="stMarkdownContainer"] ol {
        direction: rtl !important;
        text-align: right !important;
        padding-right: 20px !important;
        padding-left: 0 !important;
    }
    
    /* ุนูุงุตุฑ ุงููุงุฆูุฉ */
    .main li,
    [data-testid="stMarkdownContainer"] li {
        direction: rtl !important;
        text-align: right !important;
    }
    
    /* ุงูุฌุฏุงูู */
    .main table,
    [data-testid="stMarkdownContainer"] table {
        direction: rtl !important;
    }
    
    .main th, .main td,
    [data-testid="stMarkdownContainer"] th,
    [data-testid="stMarkdownContainer"] td {
        text-align: right !important;
    }
    
    /* ููุฏ ุงูุจุฑูุฌุฉ ูุจูู LTR */
    .main code, .main pre,
    [data-testid="stMarkdownContainer"] code,
    [data-testid="stMarkdownContainer"] pre {
        direction: ltr !important;
        text-align: left !important;
        unicode-bidi: embed;
    }
    
    /* ========== ุงูุฃุฒุฑุงุฑ ========== */
    .stButton > button {
        background: linear-gradient(90deg, #FF8C5A 0%, #FFAB76 100%);
        color: white !important;
        border: none;
        border-radius: 12px;
        padding: 12px 28px;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 140, 90, 0.3);
    }
    
    .stButton > button:hover {
        background: linear-gradient(90deg, #E07B39 0%, #FF8C5A 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 140, 90, 0.4);
    }
    
    /* ุฃุฒุฑุงุฑ ุงูุดุฑูุท ุงูุฌุงูุจู */
    [data-testid="stSidebar"] .stButton > button {
        background: rgba(255, 255, 255, 0.25) !important;
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
    }
    
    [data-testid="stSidebar"] .stButton > button:hover {
        background: rgba(255, 255, 255, 0.35) !important;
    }
    
    /* ุงูุจุทุงูุงุช */
    .info-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(255, 140, 90, 0.12);
        border: 1px solid #FFE4D6;
        margin: 12px 0;
        direction: rtl;
        text-align: right;
    }
    
    /* ุฑุณุงุฆู ุงูุฏุฑุฏุดุฉ */
    .chat-user {
        background: linear-gradient(135deg, #FFE8D6 0%, #FFD9C0 100%);
        border-radius: 18px 18px 18px 5px;
        padding: 16px 20px;
        margin: 12px 0;
        border-right: 4px solid #FF8C5A;
        border-left: none;
        animation: slideInRight 0.4s ease;
        direction: rtl;
        text-align: right;
    }
    
    .chat-assistant {
        background: linear-gradient(135deg, #FFFFFF 0%, #FFF8F0 100%);
        border-radius: 18px 18px 5px 18px;
        padding: 16px 20px;
        margin: 12px 0;
        border-right: 4px solid #FFAB76;
        border-left: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        animation: slideInLeft 0.4s ease;
        direction: rtl;
        text-align: right;
    }
    
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    /* ุฑูุน ุงููููุงุช - ุงูููุทูุฉ ุงูุฑุฆูุณูุฉ ููุท */
    .main [data-testid="stFileUploader"] {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 2px dashed #FFAB76;
    }
    
    .main [data-testid="stFileUploader"]:hover {
        border-color: #FF8C5A;
        background: #FFFBF5;
    }
    
    /* ูุฑุจุน ุงููุต */
    .stTextArea textarea, .stTextInput input {
        border-radius: 12px;
        border: 2px solid #FFE4D6;
        background: white;
        direction: rtl;
        text-align: right;
    }
    
    .stTextArea textarea:focus, .stTextInput input:focus {
        border-color: #FF8C5A;
        box-shadow: 0 0 15px rgba(255, 140, 90, 0.2);
    }
    
    /* ุงูุชุจููุจุงุช */
    .stTabs [data-baseweb="tab-list"] {
        gap: 8px;
        background: white;
        border-radius: 12px;
        padding: 8px;
        direction: rtl;
    }
    
    .stTabs [data-baseweb="tab"] {
        border-radius: 10px;
        padding: 12px 24px;
        background: #FFF5EB;
    }
    
    .stTabs [aria-selected="true"] {
        background: linear-gradient(90deg, #FF8C5A 0%, #FFAB76 100%) !important;
        color: white !important;
    }
    
    /* ุดุฑูุท ุงูุชูุฏู */
    .stProgress > div > div {
        background: linear-gradient(90deg, #FF8C5A 0%, #FFAB76 100%);
    }
    
    /* Expander */
    .streamlit-expanderHeader {
        background: linear-gradient(90deg, #FFF8F0 0%, #FFE8D6 100%);
        border-radius: 12px;
        font-weight: bold;
        direction: rtl;
        text-align: right;
    }
    
    .main [data-testid="stExpander"] {
        direction: rtl;
        text-align: right;
    }
    
    .main [data-testid="stExpander"] p,
    .main [data-testid="stExpander"] div {
        direction: rtl !important;
        text-align: right !important;
    }
    
    /* ุงูุดุนุงุฑ */
    .logo-container {
        text-align: center;
        padding: 25px;
        background: linear-gradient(135deg, #FFF8F0 0%, #FFE8D6 100%);
        border-radius: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(255, 140, 90, 0.15);
    }
    
    .logo-title {
        font-size: 28px;
        font-weight: bold;
        color: #E07B39;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        line-height: 1.4;
    }
    
    .logo-subtitle {
        font-size: 16px;
        color: #D4703A;
        margin-top: 10px;
    }
    
    /* Footer */
    .footer {
        text-align: center;
        padding: 25px;
        color: #D4703A;
        font-size: 14px;
        margin-top: 40px;
        border-top: 2px solid #FFE4D6;
        background: linear-gradient(180deg, transparent 0%, #FFF8F0 100%);
    }
    
    .designer-name {
        font-size: 16px;
        font-weight: bold;
        color: #E07B39;
        margin-top: 8px;
    }
</style>
""", unsafe_allow_html=True)

# ุงูุชุนูููุงุช ุงููุญุณููุฉ ููุชุญููู
SYSTEM_PROMPT = """
ุฃูุช ุฎุจูุฑ ูุชุฎุตุต ูู ุดุฑุญ ุงูุฃูุฑุงู ุงูุจุญุซูุฉ ูู ุงูุงูุชุตุงุฏ ุงูููุงุณู (Econometrics). ูููุชู ูู ุชุญููู ุงูููุงูุงุช ุงูุฃูุงุฏูููุฉ ูุชูุฏูู ุดุฑุญ ุดุงููุ ุฏูููุ ููุนููุ ูููู ูุจุณุท ููุงุถุญ ููุจุงุญุซูู ูุทูุงุจ ุงูุฏุฑุงุณุงุช ุงูุนููุง.

## ๐ฏ ุงููุฏู ุงูุฃุณุงุณู:
ุชูููู ุงูุจุงุญุซ ูู ููู ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑ ุจุดูู ูุงูู: ูุงููุชูุ ุดุฑูุทูุ ูุฑุถูุงุชูุ ูุชู ููุณุชุฎุฏูุ ูุชู ูุง ููุณุชุฎุฏูุ ุงูุญุงูุงุช ุงูุฎุงุตุฉุ ููู ุงูุชูุงุตูู ุงููุชุนููุฉ ุจู.

## ๐ ูููุฌูุฉ ุงูุชุญููู ุงูุดุงููุฉ:

### 1๏ธโฃ ุงูุชุดุฑูุญ ุงูููููู ูููุฑูุฉ:

#### ุงูููุฏูุฉ (Introduction):
- ุญุฏุฏ **ุงููุณุงููุฉ ุงูุฑุฆูุณูุฉ (Contribution)** ุจุฏูุฉ
- ูุง ุงููุดููุฉ ุงูุชู ุชุญููุง ูุฐู ุงููุฑูุฉุ
- ููู ุชุฎุชูู ุนู ุงูุฃุนูุงู ุงูุณุงุจูุฉุ

#### ุงูุฅุนุฏุงุฏ (Setup/Framework):
- ุงุดุฑุญ **ุดูู ุงูุฏุงูุฉ** ุงูุฃุณุงุณูุฉ (ูุซู: Y = m(X) + U)
- ูุถูุญ **ุฎุตุงุฆุต ุญุฏ ุงูุฎุทุฃ** U
- ุงุดุฑุญ ูู **ุฑูุฒ** ูุณุชุฎุฏู ุจุงูุชูุตูู

#### ุงููุฑุถูุงุช (Assumptions):
- ุงุดุฑุญ **ูู ูุฑุถูุฉ** (A1, A2, A3...) ุจุงูุชูุตูู
- ูุถูุญ **ููุงุฐุง** ููุถุนุช ูู ูุฑุถูุฉ
- ูู ูู **ูุงูุนูุฉ** ูู ุงูุชุทุจูู ุงูุนูููุ
- ูุงุฐุง ูุญุฏุซ ุฅุฐุง **ุงูุชูููุช** ุงููุฑุถูุฉุ

#### ุงููุธุฑูุงุช (Theorems):
- ุงุดุฑุญ ูู ูุธุฑูุฉ ุจูุบุฉ ุจุณูุทุฉ
- **Theorem 1**: ุนุงุฏุฉู ุงูุงุชุณุงู (Consistency)
- **Theorem 2**: ุงูุชูุฒูุน ุงูููุงุฑุจ (Asymptotic Normality)
- ูุง ูู **ุงูุฏูุงูุฉ ุงูุนูููุฉ** ููู ูุธุฑูุฉุ

### 2๏ธโฃ ุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ูู ุฃุฌุฒุงุก ูุญุฏุฏุฉ:

#### ๐งช ูู ุฌุฒุก ุงููุญุงูุงุฉ (Monte Carlo Simulation):
- **ุฃุญุฌุงู ุงูุนููุงุช** ุงููุฎุชุจุฑุฉ (N = 50, 100, 500, 1000...)
- **ุนุฏุฏ ุงูุชูุฑุงุฑุงุช** (Replications)
- **ุงูุชุญูุฒ (Bias)** ูู ุงูุนููุงุช ุงูุตุบูุฑุฉ
- **ุงูุงูุญุฑุงู ุงููุนูุงุฑู (SD)** ูุงูุฌุฐุฑ ุงูุชุฑุจูุนู ููุชูุณุท ูุฑุจุน ุงูุฎุทุฃ (RMSE)
- **ููุงุฑูุฉ ุงูุฃุฏุงุก** ูุน ุงูุทุฑู ุงูุจุฏููุฉ
- **ุญุฌู ุงูุงุฎุชุจุงุฑ ุงููุนูู (Actual Size)** vs ุงูุงุณูู
- **ููุฉ ุงูุงุฎุชุจุงุฑ (Power)** ูู ุณููุงุฑูููุงุช ูุฎุชููุฉ

#### ๐ ูู ุงูููุงูุด (Footnotes):
- **ุงูููุงุญุธุงุช ุงูุชูููุฉ** ุงููููุฉ
- **ุงูุงุณุชุซูุงุกุงุช** ูุงูุชุญูุธุงุช
- **ุงููุฑุงุฌุน** ููุฃูุฑุงู ุงูุฃุณุงุณูุฉ
- **ุงูุชูุถูุญุงุช** ูููุตุทูุญุงุช

#### ๐ป ูู ุงูุฌุฒุก ุงูุชุทุจููู (Empirical Application):
- **ุงูุจูุงูุงุช ุงููุณุชุฎุฏูุฉ** (ุงููุตุฏุฑุ ุงููุชุฑุฉุ ุงููุชุบูุฑุงุช)
- **ููููุฉ ุงูุชุทุจูู** ุงูุนููู ุฎุทูุฉ ุจุฎุทูุฉ
- **ุชูุณูุฑ ุงููุชุงุฆุฌ** ูุงููุนุงููุงุช
- **ุงูููุงุฑูุฉ** ูุน ูุชุงุฆุฌ ุงูุทุฑู ุงูุฃุฎุฑู

#### ๐ ูู ุงูููุญู (Appendix):
- **ุงูุจุฑุงููู** ุงูุฑูุงุถูุฉ ุงููููุฉ (ููุฎุต)
- **ุงูุญุงูุงุช ุงูุฎุงุตุฉ** ูุงูุชุนูููุงุช
- **ุงูุฌุฏุงูู ุงูุฅุถุงููุฉ** ููุชุงุฆุฌ ุงูุญุณุงุณูุฉ

### 3๏ธโฃ ูููู ุงูุฅุฌุงุจุฉ ุงููุทููุจ:

---

## ๐ ููุฎุต ุชูููุฐู
[ููุฑุฉ ูุงุญุฏุฉ ุดุงููุฉ ุชูุฎุต ุงููุฑูุฉ ูุงููููุฐุฌ]

## ๐ฏ ูุง ูู ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑุ
[ุดุฑุญ ูุจุณุท ููุงุถุญ ููููุฑุฉ ุงูุฃุณุงุณูุฉ]
- ุงูุงุณู ุงููุงูู ูุงููุฎุชุตุฑ
- ุงูุบุฑุถ ุงูุฑุฆูุณู
- ุงูุณูุงู ุงูุชุงุฑูุฎู

## ๐ ุงูุตูุบุฉ ุงูุฑูุงุถูุฉ
[ุงููุนุงุฏูุงุช ุงูุฃุณุงุณูุฉ]
- ุงููุนุงุฏูุฉ ุงูุฑุฆูุณูุฉ
- ุดุฑุญ ูู ุฑูุฒ
- ุงููุนุงุฏูุงุช ุงููุณุงุนุฏุฉ (ุฅู ูุฌุฏุช)

## โ ุงููุฑุถูุงุช ูุงูุดุฑูุท (Assumptions)
[ูุงุฆูุฉ ููุตูุฉ ุจูู ูุฑุถูุฉ]
| ุงููุฑุถูุฉ | ุงููุตู | ุงูุณุจุจ | ูุงุฐุง ุฅุฐุง ุงูุชูููุช |
|---------|-------|-------|------------------|

## โฐ ูุชู ููุณุชุฎุฏู ูุฐุง ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑุ
[ุงูุญุงูุงุช ุงูููุงุณุจุฉ ููุงุณุชุฎุฏุงู ุจุงูุชูุตูู]
- ุงูุดุฑูุท ุงููุซูู
- ุฃููุงุน ุงูุจูุงูุงุช ุงูููุงุณุจุฉ
- ุงููุดุงูู ุงูุชู ูุญููุง

## โ ูุชู ูุง ููุณุชุฎุฏูุ
[ุงูุญุงูุงุช ุบูุฑ ุงูููุงุณุจุฉ ูุงููููุฏ]
- ููุงูุน ุงูุงุณุชุฎุฏุงู
- ุงูุจุฏุงุฆู ุงูููุชุฑุญุฉ ููู ุญุงูุฉ

## ๐ ุงูุญุงูุงุช ุงูุฎุงุตุฉ ูุงูุชุนุฏููุงุช
[ุงูุงุณุชุซูุงุกุงุช ูุงูุชูููุนุงุช]
- ุงูุชุนุฏููุงุช ููุนููุงุช ุงูุตุบูุฑุฉ
- ุญุงูุงุช ุงูุจูุงูุงุช ุงูุดุงุฐุฉ
- ุงูุชุนูููุงุช ุงูููููุฉ

## ๐ ุงูุชุทูุฑ ุงูุชุงุฑูุฎู
[ููู ุชุทูุฑ ูุฐุง ุงููููุฐุฌ]
- ุงููุฑูุฉ ุงูุฃุตููุฉ ููุคูููุง
- ุงูุชุทูุฑุงุช ุงููุงุญูุฉ
- ุงูุฅุตุฏุงุฑุงุช ุงููุญุณูุฉ

## ๐งช ููุฎุต ูุชุงุฆุฌ ุงููุญุงูุงุฉ (Monte Carlo)
[ุฌุฏูู ููุฎุต ูู ุฌุฒุก ุงููุญุงูุงุฉ]
| ุญุฌู ุงูุนููุฉ | ุงูุชุญูุฒ | RMSE | ุงูุญุฌู ุงููุนูู | ุงูููุฉ |
|------------|--------|------|--------------|-------|

**ุงูุชูุณูุฑ**: [ุดุฑุญ ุงููุชุงุฆุฌ]

## ๐ป ุฎุทูุงุช ุงูุชุทุจูู ุงูุนููู
[ููููุฉ ุชุทุจูู ุงููููุฐุฌ ุฎุทูุฉ ุจุฎุทูุฉ]
1. ุชุญุถูุฑ ุงูุจูุงูุงุช
2. ุงุฎุชุจุงุฑ ุงููุฑุถูุงุช
3. ุงูุชูุฏูุฑ
4. ุงูุงุณุชุฏูุงู

## ๐ ุฎุทุฉ ุงูุชุนูู ุงูููุชุฑุญุฉ
[ูุง ูุญุชุงุฌ ุงูุจุงุญุซ ุชุนููู ูุจู ุงูุชุทุจูู]

**ุงููุชุทูุจุงุช ุงูุฑูุงุถูุฉ:**
- [ ] ุฌุจุฑ ุงููุตูููุงุช
- [ ] ุงููุธุฑูุฉ ุงูุชูุงุฑุจูุฉ
- [ ] ...

**ุงูููุงููู ุงูุฃุณุงุณูุฉ:**
- [ ] ...

**ุงูุฃูุฑุงู ุงููุฑุฌุนูุฉ ูููุฑุงุกุฉ:**
1. [ุงููุฑูุฉ] - [ุงูุณุจุจ]
2. ...

## ๐ ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑูู (Identification Strategy)
[ููู ุชุซุจุช ุงููุฑูุฉ ุงูุนูุงูุฉ ุงูุณุจุจูุฉุ]
- ุงูุทุฑููุฉ ุงููุณุชุฎุฏูุฉ
- ุงููุชุบูุฑุงุช ุงูุฃุฏูุงุชูุฉ (ุฅู ูุฌุฏุช)
- ููุงุท ุงูููุฉ ูุงูุถุนู

## ๐ก๏ธ ุงุฎุชุจุงุฑุงุช ุงููุชุงูุฉ (Robustness Checks)
[ููุฎุต ุฌููุน ุงุฎุชุจุงุฑุงุช ุงููุชุงูุฉ ูู ุงููุฑูุฉ]
| ุงูุงุฎุชุจุงุฑ | ุงููุชูุฌุฉ | ุงูุชูุณูุฑ |
|----------|---------|---------|

## ๐ ุชุญููู ุงูุฌุฏุงูู ุงูุฑุฆูุณูุฉ
[ุชุญููู ููุตู ูุฃูู ุฌุฏูู ูู ุงููุฑูุฉ]

## โ๏ธ ุงููุดุงูู ุงูุงูุชุตุงุฏูุฉ ุงูููุงุณูุฉ
[ููู ุชุนุงููุช ุงููุฑูุฉ ูุน ุงููุดุงูู ุงููุญุชููุฉ]

## โ ููุงุท ุงูููุฉ
[ูุง ุงูุฐู ุฃุฌุงุฏุชู ุงููุฑูุฉ]

## โ ููุงุท ุงูุถุนู ูุงููููุฏ
[ุงููููุฏ ูุงูุชุญูุธุงุช]

## ๐ ุงููุฑุงุฌุน ูุงูููุงุฑุฏ
[ุงูุฃูุฑุงู ูุงููุชุจ ุงูููุตู ุจูุง]

---

## ๐ก ููุงุนุฏ ุฌูุฏุฉ ุงูุดุฑุญ:

1. **ุงูุฏูุฉ**: ูุฏู ูุนูููุงุช ุฏูููุฉ ููุนููุฉ ูู ุงููุฑูุฉ ูุจุงุดุฑุฉ
2. **ุงูุจุณุงุทุฉ**: ุงุดุฑุญ ุงูููุงููู ุงููุนูุฏุฉ ุจูุบุฉ ุจุณูุทุฉ
3. **ุงูุดููููุฉ**: ูุง ุชุชุฑู ุชูุตููุฉ ูููุฉ
4. **ุงูุชูุธูู**: ุงุณุชุฎุฏู ุงููููู ุงููุญุฏุฏ ุฏุงุฆูุงู
5. **ุงูุฃูุซูุฉ**: ูุฏู ุฃูุซูุฉ ุชูุถูุญูุฉ ุนูุฏ ุงูุญุงุฌุฉ
6. **ุญููุฉ ุงููููุฐุฌ ุงููุนุจุฉ**: ุงุจุฏุฃ ุจุงูุญุงูุฉ ุงูุจุณูุทุฉ (K=1) ุซู ุนูู
7. **ุฑุจุท ุงูููุงููู**: ุงุฑุจุท ุงููููุฐุฌ ุจุงูููุงุฐุฌ ุงููุดุงุจูุฉ ุฃู ุงูุจุฏููุฉ
8. **ุงูุชุญุฐูุฑุงุช**: ูุจูู ุนูู ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูู ุงูุชุทุจูู
9. **ุงูุญูุงุฏ**: ูุฏู ููุฏุงู ููุถูุนูุงู ูููุฑูุฉ (ููุงุท ุงูููุฉ ูุงูุถุนู)
10. **ุงูุนูููุฉ**: ุฑูุฒ ุนูู ูุง ูุญุชุงุฌู ุงูุจุงุญุซ ูุนููุงู ููุชุทุจูู

## โ๏ธ ููุงุญุธุงุช ูููุฉ:
- ุฅุฐุง ูู ุชุฌุฏ ูุนูููุฉ ูู ุงููุฑูุฉุ ุตุฑูุญ ุจุฐูู
- ุฅุฐุง ูุงู ููุงู ุบููุถุ ุฃุดุฑ ุฅููู
- ูุฏู ุจุฏุงุฆู ุนูุฏูุง ูููู ุงููููุฐุฌ ุบูุฑ ููุงุณุจ
- ุงุณุชุฎุฏู ุงููุตุทูุญุงุช ุงูุนุฑุจูุฉ ูุน ุฐูุฑ ุงูููุงุจู ุงูุฅูุฌููุฒู

---

## ๐ฌ ุชุนูููุงุช ูุชูุฏูุฉ ูุชุญููู ุฃุนูู:

### 4๏ธโฃ ุชุญููู ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑูู (Identification Strategy):
- ูุง ูู **ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑูู** ุงููุณุชุฎุฏูุฉุ (IV, RDD, DID, Matching...)
- ูู ููุงู **ูุชุบูุฑุงุช ุฃุฏูุงุชูุฉ** (Instrumental Variables)ุ ูุง ููุ
- ูุง ูู **ุดุฑูุท ุงูุตูุงุญูุฉ** ููุฃุฏูุงุชุ (Relevance, Exogeneity)
- ูู ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑูู **ูููุนุฉ**ุ ูุง ููุงุท ุงูุถุนู ุงููุญุชููุฉุ

### 5๏ธโฃ ุชุญููู ุงุฎุชุจุงุฑุงุช ุงููุชุงูุฉ (Robustness Checks):
ุงุจุญุซ ุนู ูุงุณุชุฎุฑุฌ ุฌููุน ุงุฎุชุจุงุฑุงุช ุงููุชุงูุฉ ูู ุงููุฑูุฉ:
- **ุชุบููุฑ ุงููุชุบูุฑุงุช ุงูุถุงุจุทุฉ**: ูู ุงููุชุงุฆุฌ ุญุณุงุณุฉ ูุฅุถุงูุฉ/ุญุฐู ูุชุบูุฑุงุชุ
- **ุนููุงุช ูุฑุนูุฉ ูุฎุชููุฉ**: ูู ุงููุชุงุฆุฌ ูุชุณูุฉ ุนุจุฑ ูุชุฑุงุช ุฒูููุฉ/ูุฌููุนุงุช ูุฎุชููุฉุ
- **ููุฏูุฑุงุช ุจุฏููุฉ**: (OLS, IV, GMM, Fixed Effects...)
- **ุชุนุฑููุงุช ุจุฏููุฉ ูููุชุบูุฑุงุช**: ูู ุงููุชุงุฆุฌ ุชุชุบูุฑ ุจุชุนุฑููุงุช ูุฎุชููุฉุ
- **ุงุฎุชุจุงุฑุงุช Placebo**: ูู ููุงู ุงุฎุชุจุงุฑุงุช ููููุฉุ ูุงุฐุง ุฃุธูุฑุชุ
- **ุชุญููู ุงูุญุณุงุณูุฉ** (Sensitivity Analysis): ูุฏู ุญุณุงุณูุฉ ุงููุชุงุฆุฌ ูููุฑุถูุงุช

### 6๏ธโฃ ูุฑุงุกุฉ ุงูุฌุฏุงูู ุจุนูู (Tables Deep Dive):
ููู ุฌุฏูู ูู ุงููุฑูุฉ:
- **ุงูุฌุฏูู ุงูุฑุฆูุณู**: ุญุฏุฏ ุงูุฃุนูุฏุฉ ุงูุฃุณุงุณูุฉ vs ุฃุนูุฏุฉ ุงููุชุงูุฉ
- **ุงููุฌูู ูุงูุฏูุงูุฉ ุงูุฅุญุตุงุฆูุฉ**: (* p<0.10, ** p<0.05, *** p<0.01)
- **ุงูุฃุฎุทุงุก ุงููุนูุงุฑูุฉ**: ูู ูู Clusteredุ Robustุ ุนูู ุฃู ูุณุชููุ
- **Rยฒ ู Adjusted Rยฒ**: ูุง ุงูููุฉ ุงูุชูุณูุฑูุฉ ูููููุฐุฌุ
- **ุนุฏุฏ ุงููุดุงูุฏุงุช (N)**: ูู ูุชุบูุฑ ุจูู ุงูุฃุนูุฏุฉุ ููุงุฐุงุ
- **Fixed Effects ุงููุณุชุฎุฏูุฉ**: (Year FE, Industry FE, Firm FE...)

### 7๏ธโฃ ุงููุดุงูู ุงูุงูุชุตุงุฏูุฉ ุงูููุงุณูุฉ (Econometric Issues):
ุญุฏุฏ ููู ุชุนุงููุช ุงููุฑูุฉ ูุน:
- **ุงูุฏุงุฎููุฉ (Endogeneity)**: ูู ููุงู ูุดููุฉ ุณุจุจูุฉ ุนูุณูุฉ ุฃู ูุชุบูุฑุงุช ูุญุฐููุฉุ
- **ุนุฏู ุชุฌุงูุณ ุงูุชุจุงูู (Heteroskedasticity)**: ูุง ุงูุญู ุงููุณุชุฎุฏูุ
- **ุงูุงุฑุชุจุงุท ุงูุฐุงุชู (Autocorrelation)**: ุฎุงุตุฉ ูู ุจูุงูุงุช ุงูุณูุงุณู ุงูุฒูููุฉ
- **ุงูุชุญูุฒ ูู ุงูุนููุงุช ุงูุตุบูุฑุฉ (Small Sample Bias)**: ูู N ูุงููุฉุ
- **ูุดููุฉ ุงูุงุฎุชูุงุฑ (Selection Bias)**: ูู ููุงู ุชุญูุฒ ูู ุงูุนููุฉุ
- **ุงูููู ุงููุชุทุฑูุฉ (Outliers)**: ููู ุชู ุงูุชุนุงูู ูุนูุงุ

### 8๏ธโฃ ูุฑุงุกุฉ ูุง ุจูู ุงูุณุทูุฑ:
- **ูุจุฑุฉ ุงููุชูุงุจ**: ูู ูุจุงูุบูู ูู ุงููุชุงุฆุฌ ุฃู ูุชุญูุธููุ
- **ูุง ูู ูููู**: ูู ููุงู ูุชุงุฆุฌ ูุชููุนุฉ ูู ุชูุฐูุฑุ
- **ุงูุชุญูุฒ ุงููุญุชูู ููุจุงุญุซูู**: ูู ูุฏููู ูููู ูุณุจูุ
- **ุงููุฌูุงุช**: ูุง ุงูุฐู ูู ุชุฌุจ ุนููู ุงููุฑูุฉุ

### 9๏ธโฃ ุงูุชูููู ุงูููุฏู ุงูุดุงูู:

#### ููุงุท ุงูููุฉ:
- ูุง ุงูุฐู ุฃุฌุงุฏุชู ุงููุฑูุฉุ
- ูุง ูุฏู ุฅููุงุน ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑููุ
- ูู ุงูุจูุงูุงุช ูุฑูุฏุฉ ุฃู ููููุฉุ

#### ููุงุท ุงูุถุนู:
- ูุง ุงููุฑุถูุงุช ุบูุฑ ุงููุงูุนูุฉุ
- ูุง ุงูุชูุฏูุฏุงุช ููุตูุงุญูุฉ ุงูุฏุงุฎููุฉ (Internal Validity)ุ
- ูุง ุงูุชูุฏูุฏุงุช ููุตูุงุญูุฉ ุงูุฎุงุฑุฌูุฉ (External Validity)ุ
- ูู ูููู ุชุนููู ุงููุชุงุฆุฌุ

#### ุฃุณุฆูุฉ ูู ุชูุฌุจ:
- ูุง ุงูุฃุณุฆูุฉ ุงูุชู ุชุฑูุชูุง ุงููุฑูุฉ ููุชูุญุฉุ
- ูุง ุงูุงูุชุฏุงุฏุงุช ุงูููููุฉ ููุจุญุซุ

### ๐ ุงููููู ุงูููุญุฏ ููุฑุงุกุฉ ุฃู ุฌุฏูู:

```
๐ ุชุญููู ุงูุฌุฏูู [ุฑูู]:
โโโ ุงููุฏู: [ูุงุฐุง ูุฎุชุจุฑ ูุฐุง ุงูุฌุฏููุ]
โโโ ุงููุชุบูุฑ ุงูุชุงุจุน: [Y]
โโโ ุงููุชุบูุฑุงุช ุงููุณุชููุฉ ุงูุฑุฆูุณูุฉ: [X1, X2...]
โโโ ุงููุชุบูุฑุงุช ุงูุถุงุจุทุฉ: [Controls]
โโโ Fixed Effects: [ููุนูุง]
โโโ Clustering: [ุนูู ุฃู ูุณุชูู]
โโโ ุงููุชูุฌุฉ ุงูุฑุฆูุณูุฉ: [ฮฒ = ุุ ูุนูููุฉุ]
โโโ ุงูุชูุณูุฑ ุงูุงูุชุตุงุฏู: [ูุงุฐุง ูุนูู ูุฐุง ุนูููุงูุ]
โโโ ุงูููุงุญุธุงุช: [ุฃู ุดูุก ุบูุฑ ุนุงุฏู]
```

### ๐ ุงุณุชุฑุงุชูุฌูุฉ ุงููุฑุงุกุฉ ุงููุซูู (5 ูุฑุงุญู):

**ุงููุฑุญูุฉ 1 - ุงููุณุญ ุงูุณุฑูุน (5 ุฏูุงุฆู):**
- ุงูุนููุงู โ Abstract โ ุงูููุฏูุฉ (ุฃูู ูุขุฎุฑ ููุฑุฉ) โ ุงูุฎุงุชูุฉ
- ุงููุฏู: ููู ุงูุณุคุงู ูุงูุฅุฌุงุจุฉ ุงูุฑุฆูุณูุฉ

**ุงููุฑุญูุฉ 2 - ููู ุงูุจููุฉ (10 ุฏูุงุฆู):**
- ุชุตูุญ ุงูุฌุฏุงูู ูุงูุฃุดูุงู
- ูุฑุงุกุฉ ุนูุงููู ุงูุฃูุณุงู
- ุงููุฏู: ููู ูููู ุงูุญุฌุฉ

**ุงููุฑุญูุฉ 3 - ุงููุฑุงุกุฉ ุงูุงูุชูุงุฆูุฉ (20 ุฏูููุฉ):**
- ูุณู The Setup/Model
- ูุณู Data
- ุงูุฌุฏูู ุงูุฑุฆูุณู (Main Results)
- ุงููุฏู: ููู ุงููููุฌูุฉ ูุงููุชุงุฆุฌ ุงูุฃุณุงุณูุฉ

**ุงููุฑุญูุฉ 4 - ุงููุฑุงุกุฉ ุงูููุฏูุฉ (15 ุฏูููุฉ):**
- ูุณู Robustness
- ุงูููุงูุด ุงููููุฉ
- ุงููุฏู: ุชูููู ููุซูููุฉ ุงููุชุงุฆุฌ

**ุงููุฑุญูุฉ 5 - ุงูุชุนูู (ุญุณุจ ุงูุญุงุฌุฉ):**
- ุงูุจุฑุงููู ูู ุงูููุญู
- ุงูุชูุงุตูู ุงูุชูููุฉ
- ุงููุฏู: ููู ุงูุชูุงุตูู ุงูุฏูููุฉ

### ๐ ุฃุถู ุฏุงุฆูุงู ูู ููุงูุฉ ุงูุชุญููู:

## ๐ ููุฎุต ููุงุณุชุฎุฏุงู ุงูุณุฑูุน
[ุฌุฏูู ูู ุตูุญุฉ ูุงุญุฏุฉ ููุฎุต ูู ุดูุก]

| ุงูุนูุตุฑ | ุงูุชูุงุตูู |
|--------|----------|
| ุงุณู ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑ | |
| ุงูุบุฑุถ ุงูุฑุฆูุณู | |
| ุงููุนุงุฏูุฉ ุงูุฃุณุงุณูุฉ | |
| ุงููุฑุถูุงุช ุงูุญุฑุฌุฉ | |
| ูุชู ููุณุชุฎุฏู | |
| ูุชู ูุง ููุณุชุฎุฏู | |
| ุงูุจุฏุงุฆู ุงููุชุงุญุฉ | |
| ุงูุฃููุงุฏ/ุงูุจุฑุงูุฌ | (Stata, R, Python) |

## โ ุฃุณุฆูุฉ ูููุฑุงุฌุนุฉ ุงูุฐุงุชูุฉ
[5-10 ุฃุณุฆูุฉ ูููู ููุจุงุญุซ ุงุฎุชุจุงุฑ ูููู ุจูุง]

## ๐จ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูู ุงูุชุทุจูู
[ูุงุฆูุฉ ุจุงูุฃุฎุทุงุก ุงูุชู ูุฌุจ ุชุฌูุจูุง]

## ๐ ูุณุงุฑ ุงููุฑุงุกุฉ ุงูููุชุฑุญ
[ุชุฑุชูุจ ุงูุฃูุฑุงู ูููุฑุงุกุฉ ูููู ุฃุนูู]
1. ูุฑูุฉ ุชูููุฏูุฉ: [ุงุณู ุงููุฑูุฉ]
2. ุงููุฑูุฉ ุงูุญุงููุฉ
3. ูุฑูุฉ ููุชุนูู: [ุงุณู ุงููุฑูุฉ]
4. ูุฑูุฉ ุชุทุจูููุฉ: [ุงุณู ุงููุฑูุฉ]

---

## ๐ฌ ุชุนูููุงุช ูุชูุฏูุฉ ุฅุถุงููุฉ:

### 1๏ธโฃ1๏ธโฃ ุชุญููู ุฎุตุงุฆุต ุงูููุฏูุฑ (Estimator Properties):
ุนูุฏ ุดุฑุญ ุฃู ููุฏูุฑ ุฌุฏูุฏุ ูุฌุจ ุชูุถูุญ ุงูุฎุตุงุฆุต ุงูุชุงููุฉ ุจุงูุชูุตูู:

#### ุฃ) ุงูุงุชุณุงู (Consistency):
- ูู ุงูููุฏูุฑ ูุชุณูุ ุฃู ูู plim(ฮฒฬ) = ฮฒุ
- ูุง ุงูุดุฑูุท ุงููุงุฒูุฉ ููุงุชุณุงูุ
- ูุงุฐุง ูุญุฏุซ ุฅุฐุง ุงูุชููุช ูุฐู ุงูุดุฑูุทุ
- **ุงูุชูุณูุฑ ุงูุจุณูุท**: "ูููุง ุฒุงุฏ ุญุฌู ุงูุนููุฉุ ุงูุชุฑุจ ุงูููุฏูุฑ ูู ุงููููุฉ ุงูุญููููุฉ"

#### ุจ) ุนุฏู ุงูุชุญูุฒ (Unbiasedness):
- ูู E(ฮฒฬ) = ฮฒุ
- ุฅุฐุง ูุงู ูุชุญูุฒุงูุ ูุง ุญุฌู ุงูุชุญูุฒุ
- ูู ุงูุชุญูุฒ ูุชูุงุดู ูุน ุฒูุงุฏุฉ ุงูุนููุฉ (Asymptotically Unbiased)ุ
- **ููุงุญุธุฉ ูููุฉ**: ุงูููุฏูุฑ ูุฏ ูููู ูุชุณูุงู ูููู ูุชุญูุฒ ูู ุงูุนููุงุช ุงูุตุบูุฑุฉ

#### ุฌ) ุงูููุงุกุฉ (Efficiency):
- ูู ุงูููุฏูุฑ ููุกุ ุฃู ูู ูู ุฃูู ุชุจุงูู ููููุ
- ูู ูุญูู ุงูุญุฏ ุงูุฃุฏูู ูู Cramรฉr-Raoุ
- ููุงุฑูุฉ ุงูุชุจุงูู ูุน ุงูููุฏุฑุงุช ุงูุจุฏููุฉ
- **BLUE**: Best Linear Unbiased Estimator (ูู OLS ุชุญุช ุดุฑูุท Gauss-Markov)

#### ุฏ) ุงูุชูุฒูุน ุงูููุงุฑุจ (Asymptotic Normality):
- ูู โn(ฮฒฬ - ฮฒ) โd N(0, V)ุ
- ูุง ูู ูุตูููุฉ ุงูุชุจุงูู-ุงูุชุจุงูู ุงููุดุชุฑู Vุ
- ููู ููุฏูุฑ Vุ (Robust, Clustered, HAC...)
- **ุงูุฃูููุฉ**: ูุณูุญ ุจุจูุงุก ูุชุฑุงุช ุงูุซูุฉ ูุงุฎุชุจุงุฑุงุช ุงููุฑุถูุงุช

### 1๏ธโฃ2๏ธโฃ ุชุญููู ูุนููู ููุชุงุฆุฌ ุงููุญุงูุงุฉ (Monte Carlo Deep Dive):

#### ุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ูู ุฌุฏุงูู ุงููุญุงูุงุฉ:
```
๐ ุฌุฏูู ุชุญููู ุงููุญุงูุงุฉ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงููุคุดุฑ          โ ุงูุชุนุฑูู                    โ ุงููููุฉ ุงููุซูู โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Bias            โ E(ฮฒฬ) - ฮฒ                   โ โ 0          โ
โ Std. Dev (SD)   โ ุงูุงูุญุฑุงู ุงููุนูุงุฑู ููุชูุฏูุฑุงุช โ ุตุบูุฑ         โ
โ RMSE            โ โ(Biasยฒ + Variance)        โ ุตุบูุฑ         โ
โ Size (5%)       โ ูุนุฏู ุงูุฑูุถ ุชุญุช Hโ          โ โ 0.05       โ
โ Power           โ ูุนุฏู ุงูุฑูุถ ุชุญุช Hโ          โ ูุฑูุจ ูู 1    โ
โ Coverage        โ ูุณุจุฉ ุงุญุชูุงุก CI ูููููุฉ ุงูุญููููุฉ โ โ 0.95    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุฃุณุฆูุฉ ูุฌุจ ุงูุฅุฌุงุจุฉ ุนูููุง ูู ุงููุญุงูุงุฉ:
1. **ูู ุนุฏุฏ ุงูุชูุฑุงุฑุงุชุ** (1000, 5000, 10000...) - ูููุง ุฒุงุฏ ูุงู ุฃูุถู
2. **ูุง ุฃุญุฌุงู ุงูุนููุงุช ุงููุฎุชุจุฑุฉุ** (N = 50, 100, 200, 500, 1000...)
3. **ููู ูุชุตุฑู ุงูููุฏูุฑ ูู ุงูุนููุงุช ุงูุตุบูุฑุฉ vs ุงููุจูุฑุฉุ**
4. **ูู Size ูุฑูุจ ูู ุงููุณุชูู ุงูุงุณูู (5%)ุ** - ุฅุฐุง ูุงุ ุงูุงุฎุชุจุงุฑ ูุดููู
5. **ููู ุชุชุบูุฑ Power ูุน ุญุฌู ุงูุนููุฉ ูุญุฌู ุงูุชุฃุซูุฑุ**
6. **ูุง DGP (Data Generating Process) ุงููุณุชุฎุฏูุ** - ูู ูู ูุงูุนูุ

#### ุชูุณูุฑ ุงููุชุงุฆุฌ:
| ุงูููุงุญุธุฉ | ุงูุชูุณูุฑ |
|----------|---------|
| Bias ูุจูุฑ ูุน N ุตุบูุฑุ ูุชูุงุดู ูุน N ูุจูุฑ | ุชุญูุฒ ุงูุนููุงุช ุงูุตุบูุฑุฉุ ุงูููุฏูุฑ ูุชุณู |
| Size > 0.05 | ุงูุงุฎุชุจุงุฑ ูุฑูุถ ูุซูุฑุงู (Over-rejection) |
| Size < 0.05 | ุงูุงุฎุชุจุงุฑ ูุญุงูุธ ุฌุฏุงู (Under-rejection) |
| Power ููุฎูุถุฉ | ุงูุงุฎุชุจุงุฑ ุถุนูู ูู ูุดู ุงูุจุฏูู |
| RMSE ูุง ูุชูุงูุต ูุน N | ูุดููุฉ ูู ุงูุงุชุณุงู |

### 1๏ธโฃ3๏ธโฃ ุชูุณูุฑ ูุนุงููุงุช ุงูุงูุญุฏุงุฑ ูุงูุฃุฎุทุงุก ุงููุนูุงุฑูุฉ:

#### ูุฑุงุกุฉ ุฌุฏูู ุงูุงูุญุฏุงุฑ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Variable  โ Coef (ฮฒฬ) โ Std.Err โ t-stat โ P>|t| โ CI  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Xโ        โ 0.523    โ 0.102   โ 5.13   โ 0.000 โ ... โ
โ Xโ        โ -0.087   โ 0.045   โ -1.93  โ 0.054 โ ... โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุชูุณูุฑ:
โข ฮฒฬ = 0.523: ุฒูุงุฏุฉ Xโ ุจูุญุฏุฉ ูุงุญุฏุฉ ุชุฑุชุจุท ุจุฒูุงุฏุฉ Y ุจู 0.523
โข SE = 0.102: ุฏูุฉ ุงูุชูุฏูุฑ (ูููุง ุตุบุฑ ูุงู ุฃูุถู)
โข t = ฮฒฬ/SE = 5.13: ูู ุงููุนุงูู ูุนูููุงู ูุฎุชูู ุนู ุงูุตูุฑุ
โข p-value = 0.000: ุงุญุชูุงู ุงูุญุตูู ุนูู |t| โฅ 5.13 ุชุญุช Hโ
โข CI: ูุชุฑุฉ ุงูุซูุฉ 95% ูููุนุงูู ุงูุญูููู
```

#### ุฃููุงุน ุงูุฃุฎุทุงุก ุงููุนูุงุฑูุฉ:
| ุงูููุน | ูุชู ููุณุชุฎุฏู | ุงูููุฏ (Stata) |
|-------|-------------|---------------|
| Classical | ุชุฌุงูุณ ุงูุชุจุงููุ ุงุณุชููุงู | reg y x |
| Robust (HC) | ุนุฏู ุชุฌุงูุณ ุงูุชุจุงูู | reg y x, robust |
| Clustered | ุงุฑุชุจุงุท ุฏุงุฎู ุงููุฌููุนุงุช | reg y x, cluster(id) |
| HAC (Newey-West) | ุงุฑุชุจุงุท ุฐุงุชู ูู ุงูุณูุงุณู ุงูุฒูููุฉ | newey y x, lag(4) |
| Two-way Clustered | ุงุฑุชุจุงุท ูู ุจุนุฏูู | reghdfe y x, cluster(firm year) |

### 1๏ธโฃ4๏ธโฃ ููู ุงูุฏูุงูุฉ ุงูุฅุญุตุงุฆูุฉ vs ุงูุฏูุงูุฉ ุงูุงูุชุตุงุฏูุฉ:

#### ุงูุฏูุงูุฉ ุงูุฅุญุตุงุฆูุฉ (Statistical Significance):
- p < 0.05 โ "ูุนููู ุฅุญุตุงุฆูุงู"
- ููู ูุฐุง ูุง ูุนูู ุจุงูุถุฑูุฑุฉ ุฃู ุงูุชุฃุซูุฑ "ููู"!

#### ุงูุฏูุงูุฉ ุงูุงูุชุตุงุฏูุฉ (Economic Significance):
- ูุง ุญุฌู ุงูุชุฃุซูุฑุ ูู ูู ูุจูุฑ ุนูููุงูุ
- ุงุณุชุฎุฏู ุงูุชุฃุซูุฑ ุงููุนูุงุฑู (Standardized Effect)
- ูุงุฑู ูุน ูุชุงุฆุฌ ุงูุฃุฏุจูุงุช ุงูุณุงุจูุฉ
- **ูุซุงู**: ฮฒ = 0.001*** (ูุนููู ุฌุฏุงู ููู ุถุฆูู ุงูุชุตุงุฏูุงู)

#### ุญุณุงุจ ุงูุฃูููุฉ ุงูุงูุชุตุงุฏูุฉ:
```
ุงูุชุฃุซูุฑ ุงููุนูุงุฑู = ฮฒ ร (SD_X / SD_Y)
ุงูุชูุณูุฑ: ุฒูุงุฏุฉ X ุจุงูุญุฑุงู ูุนูุงุฑู ูุงุญุฏ ุชุฑุชุจุท ุจุชุบูุฑ Y ุจู [X] ุงูุญุฑุงู ูุนูุงุฑู
```

### 1๏ธโฃ5๏ธโฃ ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุฃุฏูุงุช (IV Diagnostics):

#### ุฅุฐุง ุงุณุชุฎุฏูุช ุงููุฑูุฉ ุงููุชุบูุฑุงุช ุงูุฃุฏูุงุชูุฉ:
1. **ุงุฎุชุจุงุฑ ุงูุตูุฉ (Relevance)**: F-statistic ูู First Stage
   - F > 10 โ ุงูุฃุฏุงุฉ ูููุฉ
   - F < 10 โ ูุดููุฉ ุงูุฃุฏูุงุช ุงูุถุนููุฉ (Weak Instruments)

2. **ุงุฎุชุจุงุฑ ุงูุฎุงุฑุฌูุฉ (Exogeneity)**: ูุง ูููู ุงุฎุชุจุงุฑู ูุจุงุดุฑุฉ!
   - ูุนุชูุฏ ุนูู ุงูุญุฌุฉ ุงููุธุฑูุฉ
   - Overidentification test (ุฅุฐุง ูุงู ุนุฏุฏ ุงูุฃุฏูุงุช > ุนุฏุฏ ุงููุชุบูุฑุงุช ุงูุฏุงุฎููุฉ)

3. **ุงุฎุชุจุงุฑุงุช ูุฌุจ ุงูุจุญุซ ุนููุง**:
   - Cragg-Donald F-statistic
   - Kleibergen-Paap rk Wald F-statistic (ูู Robust SE)
   - Hansen J-statistic (Overidentification)
   - Anderson-Rubin test (Weak-IV robust)

### 1๏ธโฃ6๏ธโฃ ุชุญููู ุจูุงูุงุช ุงูุจุงูู (Panel Data Specifics):

#### ุฅุฐุง ูุงูุช ุงููุฑูุฉ ุชุณุชุฎุฏู ุจูุงูุงุช Panel:
| ุงูููุฏูุฑ | ุงููุฑุถูุฉ ุงูุฃุณุงุณูุฉ | ูุชู ููุณุชุฎุฏู |
|---------|------------------|-------------|
| Pooled OLS | ูุง ููุฌุฏ ุชุฃุซูุฑ ูุฑุฏู | ูุงุฏุฑุงู ูุง ูููู ููุงุณุจุงู |
| Fixed Effects (FE) | Corr(ฮฑแตข, Xแตขโ) โ 0 | ุงูุชุฃุซูุฑ ุงููุฑุฏู ูุฑุชุจุท ุจุงููุชุบูุฑุงุช |
| Random Effects (RE) | Corr(ฮฑแตข, Xแตขโ) = 0 | ุงูุชุฃุซูุฑ ุงููุฑุฏู ุนุดูุงุฆู ูุณุชูู |
| First Differences | ูุซู FE | ุจุฏูู ูู FE |

#### ุงุฎุชุจุงุฑ Hausman:
- Hโ: RE ูุชุณู ูููุก
- Hโ: FE ูุชุณูุ RE ุบูุฑ ูุชุณู
- ุฅุฐุง ุฑููุถุช Hโ โ ุงุณุชุฎุฏู FE

### 1๏ธโฃ7๏ธโฃ ูุฑุงุกุฉ ุงูุฃุดูุงู ุงูุจูุงููุฉ (Figures):

#### ุฃููุงุน ุงูุฃุดูุงู ุงูุดุงุฆุนุฉ:
1. **Scatter Plot + Regression Line**: ุงูุนูุงูุฉ ุงูุซูุงุฆูุฉ
2. **Residual Plots**: ูุญุต ุงููุฑุถูุงุช
3. **Event Study Graph**: ุชุฃุซูุฑุงุช ุฏููุงููููุฉ ุญูู ุญุฏุซ
4. **RDD Plot**: ุงูุงููุทุงุน ุนูุฏ ุงูุนุชุจุฉ
5. **Binned Scatter**: ุงูุนูุงูุฉ ุบูุฑ ุงูุฎุทูุฉ

#### ูุงุฐุง ุชุจุญุซ ุนูู:
- ูู ุงูุนูุงูุฉ ุฎุทูุฉ ุฃู ููุญููุฉุ
- ูู ููุงู ููู ูุชุทุฑูุฉ ูุคุซุฑุฉุ
- ูู ูุชุฑุงุช ุงูุซูุฉ ุถููุฉ ุฃู ูุงุณุนุฉุ
- ูู ุงูููุท ูุชุณู ูุน ุงููุชุงุฆุฌ ุงููููุฉุ

### 1๏ธโฃ8๏ธโฃ ุงูููุฏ ูุงูุชุทุจูู ุงูุจุฑูุฌู:

#### ุฅุฐุง ููุฑุช ุงููุฑูุฉ ููุฏุงู ุฃู ุฐูุฑุช ุงูุจุฑูุงูุฌ:
```
๐ฆ ูุนูููุงุช ุงูุชุทุจูู:
โโโ ุงูุจุฑูุงูุฌ: [Stata / R / Python / Matlab]
โโโ ุงูุญุฒู ุงููุณุชุฎุฏูุฉ: [reghdfe, fixest, linearmodels...]
โโโ ุงูุฃูุงูุฑ ุงูุฑุฆูุณูุฉ: [...]
โโโ Replication Files: [ุฑุงุจุท ุฅู ูุฌุฏ]
โโโ ุงูุจูุงูุงุช: [ูุชุงุญุฉ / ุบูุฑ ูุชุงุญุฉ]
```

#### ุฃูุงูุฑ Stata ุงูุดุงุฆุนุฉ ูู ุงูุฃูุฑุงู:
| ุงูุฃูุฑ | ุงูุงุณุชุฎุฏุงู |
|-------|----------|
| reg | OLS ุจุณูุท |
| xtreg, fe | Fixed Effects |
| ivregress 2sls | ุงููุชุบูุฑุงุช ุงูุฃุฏูุงุชูุฉ |
| reghdfe | High-dimensional FE |
| didregress | Difference-in-Differences |
| rdrobust | Regression Discontinuity |

### 1๏ธโฃ9๏ธโฃ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ (Final Checklist):

ูุจู ุฅููุงุก ุงูุชุญูููุ ุชุฃูุฏ ูู ุงูุฅุฌุงุจุฉ ุนูู:

- [ ] ูุง ุงูุณุคุงู ุงูุจุญุซู ุงูุฑุฆูุณูุ
- [ ] ูุง ุงููุณุงููุฉ ููุงุฑูุฉ ุจุงูุฃุฏุจูุงุชุ
- [ ] ูุง ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑ ุงูููุชุฑุญุ
- [ ] ูุง ุงููุฑุถูุงุช ุงููุทููุจุฉุ
- [ ] ูุง ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนุฑููุ
- [ ] ูุง ุงูุจูุงูุงุช ุงููุณุชุฎุฏูุฉุ
- [ ] ูุง ุงููุชุงุฆุฌ ุงูุฑุฆูุณูุฉุ
- [ ] ูู ุงููุชุงุฆุฌ robustุ
- [ ] ูุง ุงููููุฏ ูุงูุชุญูุธุงุชุ
- [ ] ูุง ุงูุขุซุงุฑ ุงูุนูููุฉ/ุงูุณูุงุณูุฉุ
- [ ] ูุชู ููุณุชุฎุฏู ูุฐุง ุงููููุฐุฌุ
- [ ] ูุชู ูุง ููุณุชุฎุฏูุ
- [ ] ูุง ุงูุจุฏุงุฆู ุงููุชุงุญุฉุ
- [ ] ูุง ุงูุฃูุฑุงู ุงููุฑุฌุนูุฉ ูููุฑุงุกุฉุ

### 2๏ธโฃ0๏ธโฃ ูุตุงุฆุญ ููุจุงุญุซ ุงููุจุชุฏุฆ:

1. **ูุง ุชุฎู ูู ุงูุฑูุงุถูุงุช** - ุฑูุฒ ุนูู ุงูุญุฏุณ ุฃููุงู
2. **ุงุจุฏุฃ ุจุงูุญุงูุฉ ุงูุจุณูุทุฉ** - K=1ุ ุจุฏูู Fixed Effects
3. **ุงูุฑุฃ ุงููุฑูุฉ ุงูุชูุณูุฑูุฉ ุฃููุงู** - ุฅู ูุฌุฏุช
4. **ูุง ุชูุฑุฃ ุงูุจุฑุงููู ูู ุงููุฑุงุกุฉ ุงูุฃููู**
5. **ุงุตูุน ูุงููุณ ุงูุฑููุฒ ุงูุฎุงุต ุจู**
6. **ูุงุฑู ูุน ูุง ุชุนุฑูู** - ููู ูุฎุชูู ูุฐุง ุนู OLS ุงูุนุงุฏูุ
7. **ุงุณุฃู: ููุงุฐุง ูุฐู ุงูุทุฑููุฉ ูููุณ ุบูุฑูุงุ**
8. **ุชุนูู ูู ุงูุฃุฎุทุงุก** - ุงููุฑูุฉ ุงูุฃููู ุตุนุจุฉุ ุงูุฎุงูุณุฉ ุฃุณูู
"""

# ุชููุฆุฉ ุงูุญุงูุฉ
if 'messages' not in st.session_state:
    st.session_state.messages = []
if 'analysis_result' not in st.session_state:
    st.session_state.analysis_result = None
if 'uploaded_files_content' not in st.session_state:
    st.session_state.uploaded_files_content = {}
if 'files_names' not in st.session_state:
    st.session_state.files_names = []
if 'client' not in st.session_state:
    st.session_state.client = None
if 'thinking_level' not in st.session_state:
    st.session_state.thinking_level = "HIGH"
if 'saved_api_key' not in st.session_state:
    st.session_state.saved_api_key = ""
if 'api_key_saved' not in st.session_state:
    st.session_state.api_key_saved = False


def create_word_report(content: str, title: str = "ุชูุฑูุฑ ุงูุชุญููู") -> bytes:
    """ุฅูุดุงุก ููู Word ูู ุงููุญุชูู ูุน ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ"""
    doc = DocxDocument()
    
    # ุฅุนุฏุงุฏ ุงูุตูุญุฉ ููุบุฉ ุงูุนุฑุจูุฉ (RTL)
    section = doc.sections[0]
    sectPr = section._sectPr
    bidi = OxmlElement('w:bidi')
    bidi.set(qn('w:val'), '1')
    sectPr.append(bidi)
    
    # ุงูุนููุงู ุงูุฑุฆูุณู
    title_para = doc.add_heading("๐ ููุตุฉ ุชุญููู ุฃูุฑุงู ุงูููุงุณ ุงูุงูุชุตุงุฏู", level=0)
    title_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # ูุนูููุงุช ุงูุชูุฑูุฑ
    date_str = datetime.now().strftime("%Y-%m-%d %H:%M")
    info_para = doc.add_paragraph()
    info_para.add_run(f"ุงูุชุงุฑูุฎ: {date_str}").bold = True
    info_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
    
    paper_para = doc.add_paragraph()
    paper_para.add_run(f"ุงูููุงูุฉ: {title}").bold = True
    paper_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
    
    doc.add_paragraph()  # ุณุทุฑ ูุงุฑุบ
    
    # ุชุญููู ุงููุญุชูู
    lines = content.split('\n')
    for line in lines:
        if line.strip():
            if line.startswith('## '):
                heading_text = line.replace('## ', '').replace('#', '').strip()
                heading = doc.add_heading(heading_text, level=2)
                heading.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            elif line.startswith('### '):
                heading_text = line.replace('### ', '').replace('#', '').strip()
                heading = doc.add_heading(heading_text, level=3)
                heading.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            elif line.startswith('# '):
                heading_text = line.replace('# ', '').strip()
                heading = doc.add_heading(heading_text, level=1)
                heading.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            elif line.startswith('|') or line.startswith('---'):
                # ุชุฌุงูู ุฌุฏุงูู Markdown
                continue
            elif line.startswith('- ') or line.startswith('* '):
                # ููุงุฆู ููุทูุฉ
                bullet_text = line.replace('- ', '').replace('* ', '').strip()
                para = doc.add_paragraph(bullet_text, style='List Bullet')
                para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            else:
                # ูุต ุนุงุฏู
                clean_line = line.replace('**', '').replace('*', '').replace('`', '')
                clean_line = clean_line.replace('###', '').replace('##', '').replace('#', '')
                if clean_line.strip():
                    para = doc.add_paragraph(clean_line.strip())
                    para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
    
    # Footer
    doc.add_paragraph()
    doc.add_paragraph("โ" * 50)
    footer = doc.add_paragraph()
    footer.add_run("ุชุตููู ูุชุทููุฑ: ุฏ. ูุฑูุงู ุฑูุฏุงู | Dr. Marouane Roudan")
    footer.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # ุญูุธ ุงููุณุชูุฏ ูู ุงูุฐุงูุฑุฉ
    buffer = io.BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    return buffer.getvalue()


def upload_file_to_gemini(client, file_content: bytes, filename: str):
    """ุฑูุน ููู ุฅูู Gemini ุจุงุณุชุฎุฏุงู SDK ุงูุฌุฏูุฏ"""
    with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as tmp:
        tmp.write(file_content)
        tmp_path = tmp.name
    
    try:
        uploaded_file = client.files.upload(file=tmp_path, config={"display_name": filename})
        return uploaded_file
    finally:
        os.unlink(tmp_path)


def analyze_with_gemini(client, files_content: dict, thinking_level: str, question: str = None) -> str:
    """ุชุญููู ุงูููุงูุงุช ุจุงุณุชุฎุฏุงู Gemini 3 Flash"""
    
    # ุฑูุน ุงููููุงุช
    uploaded_files = []
    for filename, file_data in files_content.items():
        try:
            uploaded_file = upload_file_to_gemini(client, file_data, filename)
            uploaded_files.append(uploaded_file)
        except Exception as e:
            st.warning(f"ุชุนุฐุฑ ุฑูุน ุงูููู {filename}: {str(e)}")
    
    if not uploaded_files:
        return "โ ูู ูุชู ุฑูุน ุฃู ูููุงุช ุจูุฌุงุญ"
    
    # ุฅุนุฏุงุฏ ุงููุญุชูู
    if question:
        prompt = f"""
{SYSTEM_PROMPT}

ุจูุงุกู ุนูู ุงูููุงูุงุช ุงููุฑููุฉุ ุฃุฌุจ ุนูู ุงูุณุคุงู ุงูุชุงูู ุจุดูู ููุตู ูุฏููู:

{question}

ูุฏู ุฅุฌุงุจุฉ ุดุงููุฉ ูุน ุงูุฅุดุงุฑุฉ ููุฃูุณุงู ุฐุงุช ุงูุตูุฉ ูู ุงูููุงู.
"""
    else:
        prompt = f"""
{SYSTEM_PROMPT}

ูู ุจุชุญููู ุงูููุงูุงุช ุงููุฑููุฉ ุชุญูููุงู ุดุงููุงู ููุนููุงู ูููุงู ูููููู ูุงูุชุนูููุงุช ุงููุญุฏุฏุฉ.

ุฑูุฒ ุนูู:
1. ุดุฑุญ ุงููููุฐุฌ/ุงูุงุฎุชุจุงุฑ ุงูุฑุฆูุณู ุจุดูู ูุจุณุท ููุงุถุญ
2. ุงุณุชุฎุฑุงุฌ ุฌููุน ุงููุฑุถูุงุช ูุดุฑุญูุง
3. ุชุญุฏูุฏ ูุชู ููุณุชุฎุฏู ููุชู ูุง ููุณุชุฎุฏู ุจุฏูุฉ
4. ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงููุญุงูุงุฉ ูุชูุธูููุง ูู ุฌุฏูู
5. ุชูุฏูู ุฎุทุฉ ุชุนูู ุนูููุฉ ููุจุงุญุซ
6. ุงูุฅุดุงุฑุฉ ููุญุงูุงุช ุงูุฎุงุตุฉ ูุงูุชุญุฐูุฑุงุช

ุงููุฏู: ุชูููู ุงูุจุงุญุซ ูู ููู ุงููููุฐุฌ ุจุดูู ูุงูู ูุชุทุจููู ุนูููุงู.
"""
    
    try:
        # ุชุญุฏูุฏ ูุณุชูู ุงูุชูููุฑ
        thinking_level_map = {
            "HIGH": types.ThinkingLevel.HIGH,
            "MEDIUM": types.ThinkingLevel.MEDIUM,
            "LOW": types.ThinkingLevel.LOW,
            "MINIMAL": types.ThinkingLevel.MINIMAL,
        }
        level = thinking_level_map.get(thinking_level, types.ThinkingLevel.HIGH)
        
        # ุฅุนุฏุงุฏ ุงููุญุชูู
        content_parts = uploaded_files + [prompt]
        
        response = client.models.generate_content(
            model="gemini-3-flash-preview",
            contents=content_parts,
            config=types.GenerateContentConfig(
                thinking_config=types.ThinkingConfig(
                    thinking_level=level
                )
            )
        )
        return response.text
    except Exception as e:
        return f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญููู: {str(e)}"


def chat_with_gemini(client, files_content: dict, thinking_level: str, messages: list, new_message: str) -> str:
    """ุงูุฏุฑุฏุดุฉ ุญูู ุงูููุงูุงุช ุจุงุณุชุฎุฏุงู Gemini 3 Flash"""
    
    # ุฑูุน ุงููููุงุช
    uploaded_files = []
    for filename, file_data in files_content.items():
        try:
            uploaded_file = upload_file_to_gemini(client, file_data, filename)
            uploaded_files.append(uploaded_file)
        except:
            pass
    
    # ุจูุงุก ุณูุงู ุงููุญุงุฏุซุฉ
    chat_context = "\n\n".join([
        f"{'ุงููุณุชุฎุฏู' if m['role'] == 'user' else 'ุงููุณุงุนุฏ'}: {m['content']}"
        for m in messages[-6:]
    ])
    
    prompt = f"""
{SYSTEM_PROMPT}

ุจูุงุกู ุนูู ุงูููุงูุงุช ุงููุฑููุฉ ูุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ:

{chat_context}

ุงูุณุคุงู ุงูุฌุฏูุฏ: {new_message}

ุฃุฌุจ ุจุดูู ุฏููู ูููุตู ูุน ุงูุฅุดุงุฑุฉ ููุฃุฌุฒุงุก ุงููุนููุฉ ูู ุงูููุงู. ุฅุฐุง ูุงู ุงูุณุคุงู ุนู ููุทุฉ ูู ุชููููุ ุงุดุฑุญูุง ุจุทุฑููุฉ ูุจุณุทุฉ ูุน ุฃูุซูุฉ.
"""
    
    try:
        # ุชุญุฏูุฏ ูุณุชูู ุงูุชูููุฑ
        thinking_level_map = {
            "HIGH": types.ThinkingLevel.HIGH,
            "MEDIUM": types.ThinkingLevel.MEDIUM,
            "LOW": types.ThinkingLevel.LOW,
            "MINIMAL": types.ThinkingLevel.MINIMAL,
        }
        level = thinking_level_map.get(thinking_level, types.ThinkingLevel.HIGH)
        
        content_parts = uploaded_files + [prompt]
        response = client.models.generate_content(
            model="gemini-3-flash-preview",
            contents=content_parts,
            config=types.GenerateContentConfig(
                thinking_config=types.ThinkingConfig(
                    thinking_level=level
                )
            )
        )
        return response.text
    except Exception as e:
        return f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}"


# ==================== ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ====================

# ุงูุดุฑูุท ุงูุฌุงูุจู
with st.sidebar:
    st.markdown("""
    <div style='text-align: center; padding: 15px;'>
        <h3 style='color: white; margin: 0; font-size: 16px;'>๐ ุงูููุตุฉ ุงูุดุงููุฉ</h3>
        <p style='color: #FFE4D6; font-size: 11px;'>ุงูููุงุณ ุงูุงูุชุตุงุฏู</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.markdown("### ๐ ููุชุงุญ API")
    
    # ุงูุชุญูู ูู ูุฌูุฏ ููุชุงุญ ูุญููุธ
    if st.session_state.api_key_saved and st.session_state.saved_api_key:
        st.success("โ ุงูููุชุงุญ ูุญููุธ")
        st.markdown(f"<p style='color: #FFE4D6; font-size: 12px;'>ุงูููุชุงุญ: ****{st.session_state.saved_api_key[-4:]}</p>", unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("๐ ุชุบููุฑ", use_container_width=True, key="change_key"):
                st.session_state.api_key_saved = False
                st.session_state.saved_api_key = ""
                st.session_state.client = None
                st.rerun()
        
        api_key = st.session_state.saved_api_key
    else:
        api_key = st.text_input(
            "ุฃุฏุฎู ููุชุงุญ Google API",
            type="password",
            help="ุงุญุตู ุนูู ููุชุงุญ API ูู Google AI Studio",
            label_visibility="collapsed",
            placeholder="ุฃุฏุฎู ููุชุงุญ API ููุง..."
        )
        
        if api_key:
            col1, col2 = st.columns(2)
            with col1:
                if st.button("๐พ ุญูุธ", use_container_width=True, key="save_key"):
                    st.session_state.saved_api_key = api_key
                    st.session_state.api_key_saved = True
                    st.success("โ ุชู ุงูุญูุธ!")
                    st.rerun()
    
    st.markdown("### โ๏ธ ุฅุนุฏุงุฏุงุช ุงููููุฐุฌ")
    thinking_level = st.selectbox(
        "ูุณุชูู ุงูุชูููุฑ (Thinking Level)",
        ["HIGH", "MEDIUM", "LOW", "MINIMAL"],
        index=0,
        help="HIGH: ุชูููุฑ ุนููู (ุงูุชุฑุงุถู) | MEDIUM: ูุชูุณุท | LOW: ุณุฑูุน | MINIMAL: ุฃุณุฑุน"
    )
    
    if api_key:
        if not st.session_state.api_key_saved:
            st.success("โ ุชู ุฅุฏุฎุงู ุงูููุชุงุญ")
        try:
            # ุฅูุดุงุก ุงูุนููู ุจุงุณุชุฎุฏุงู SDK ุงูุฌุฏูุฏ
            client = genai.Client(api_key=api_key)
            st.session_state.client = client
            st.session_state.thinking_level = thinking_level
        except Exception as e:
            st.error(f"ุฎุทุฃ ูู ุชูููู ุงููููุฐุฌ: {str(e)}")
    else:
        st.warning("โ๏ธ ูุทููุจ ููุชุงุญ API")
    
    st.markdown("---")
    
    st.markdown("### ๐ ุฑูุน ุงูููุงูุงุช")
    uploaded_files = st.file_uploader(
        "ุงุฎุชุฑ ูููุงุช PDF",
        type=['pdf'],
        accept_multiple_files=True,
        help="ุงูุญุฏ ุงูุฃูุตู: 10 ููุงูุงุช",
        label_visibility="collapsed"
    )
    
    if uploaded_files:
        if len(uploaded_files) > 10:
            st.error("โ๏ธ ุงูุญุฏ ุงูุฃูุตู 10 ูููุงุช!")
            uploaded_files = uploaded_files[:10]
        
        st.success(f"โ ุชู ุฑูุน {len(uploaded_files)} ููู")
        
        st.session_state.uploaded_files_content = {}
        st.session_state.files_names = []
        for file in uploaded_files:
            content = file.read()
            st.session_state.uploaded_files_content[file.name] = content
            st.session_state.files_names.append(file.name)
            file.seek(0)
        
        with st.expander("๐ ุงููููุงุช ุงููุฑููุนุฉ", expanded=False):
            for name in st.session_state.files_names:
                st.write(f"๐ {name}")
    
    st.markdown("---")
    
    st.markdown("""
    <div style='text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;'>
        <p style='font-size: 11px; margin: 0; color: #FFE4D6;'>ุชุตููู ูุชุทููุฑ</p>
        <p style='font-size: 14px; font-weight: bold; margin: 5px 0; color: white;'>ุฏ. ูุฑูุงู ุฑูุฏุงู</p>
        <p style='font-size: 10px; color: #FFE4D6;'>Dr. Marouane Roudan</p>
    </div>
    """, unsafe_allow_html=True)


# ุงููุญุชูู ุงูุฑุฆูุณู
st.markdown("""
<div class='logo-container'>
    <p class='logo-title'>๐ ุงูููุตุฉ ุงูุดุงููุฉ ูุดุฑุญ ุงูููุงูุงุช ุงูุฃุตููุฉ ูุงูุงุฎุชุจุงุฑุงุช ูู ุงูููุงุณ ุงูุงูุชุตุงุฏู</p>
    <p class='logo-subtitle'>The Comprehensive Platform for Explaining Original Econometric Papers and Tests</p>
</div>
""", unsafe_allow_html=True)

# ุงูุชุจููุจุงุช
tab1, tab2, tab3 = st.tabs(["๐ ุชุญููู ุงูููุงูุงุช", "๐ฌ ูุงูุฐุฉ ุงูุฏุฑุฏุดุฉ", "๐ฅ ุชุญููู ุงูุชูุฑูุฑ"])

# ==================== ุชุจููุจ ุงูุชุญููู ====================
with tab1:
    st.markdown("### ๐ ุงูุชุญููู ุงูุดุงูู ููููุงูุงุช")
    
    if not api_key:
        st.warning("โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ Google API ูู ุงูุดุฑูุท ุงูุฌุงูุจู ููุจุฏุก")
    elif not st.session_state.uploaded_files_content:
        st.info("๐ ูุฑุฌู ุฑูุน ููุงู ูุงุญุฏ ุนูู ุงูุฃูู ูู ุงูุดุฑูุท ุงูุฌุงูุจู")
    else:
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.markdown(f"""
            <div class='info-card'>
                <h4 style='color: #E07B39; margin: 0;'>๐ ุงูููุงูุงุช ุงูุฌุงูุฒุฉ ููุชุญููู</h4>
                <p style='font-size: 24px; font-weight: bold; color: #D4703A; margin: 10px 0;'>{len(st.session_state.uploaded_files_content)}</p>
                <p style='color: #888; font-size: 13px;'>ุงุถุบุท ุนูู "ุจุฏุก ุงูุชุญููู" ููุญุตูู ุนูู ุดุฑุญ ุดุงูู ูููุตู</p>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            analyze_btn = st.button("๐ ุจุฏุก ุงูุชุญููู", use_container_width=True, type="primary")
        
        if analyze_btn:
            if st.session_state.client is None:
                st.error("โ ูุฑุฌู ุงูุชุฃูุฏ ูู ุฅุฏุฎุงู ููุชุงุญ API ุตุญูุญ")
            else:
                with st.spinner("โณ ุฌุงุฑู ุชุญููู ุงูููุงูุงุช... ูุฏ ูุณุชุบุฑู ูุฐุง ุจุถุน ุฏูุงุฆู"):
                    try:
                        result = analyze_with_gemini(
                            st.session_state.client,
                            st.session_state.uploaded_files_content,
                            st.session_state.thinking_level
                        )
                        st.session_state.analysis_result = result
                    except Exception as e:
                        st.error(f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}")
        
        if st.session_state.analysis_result:
            st.markdown("---")
            st.markdown("### ๐ ูุชุงุฆุฌ ุงูุชุญููู")
            
            with st.container():
                st.markdown(f"""
                <div style='background: white; padding: 25px; border-radius: 15px; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid #FFE4D6;'>
                """, unsafe_allow_html=True)
                
                st.markdown(st.session_state.analysis_result)
                
                st.markdown("</div>", unsafe_allow_html=True)

# ==================== ุชุจููุจ ุงูุฏุฑุฏุดุฉ ====================
with tab2:
    st.markdown("### ๐ฌ ูุงูุฐุฉ ุงูุฏุฑุฏุดุฉ ุงูุชูุงุนููุฉ")
    st.markdown("ุงุทุฑุญ ุฃุณุฆูุชู ุญูู ุงูููุงูุงุช ุงููุฑููุนุฉ ููุญุตูู ุนูู ุชูุถูุญุงุช ุฅุถุงููุฉ")
    
    if not api_key:
        st.warning("โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ API ุฃููุงู")
    elif not st.session_state.uploaded_files_content:
        st.info("๐ ูุฑุฌู ุฑูุน ููุงู ูุงุญุฏ ุนูู ุงูุฃูู")
    else:
        chat_container = st.container()
        
        with chat_container:
            for msg in st.session_state.messages:
                if msg['role'] == 'user':
                    st.markdown(f"""
                    <div class='chat-user'>
                        <strong>๐งโ๐ ุฃูุช:</strong><br>{msg['content']}
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.markdown(f"""
                    <div class='chat-assistant'>
                        <strong>๐ค ุงูููุตุฉ:</strong><br>{msg['content']}
                    </div>
                    """, unsafe_allow_html=True)
        
        st.markdown("---")
        
        col1, col2 = st.columns([5, 1])
        
        with col1:
            user_question = st.text_area(
                "ุงูุชุจ ุณุคุงูู ููุง",
                placeholder="ูุซุงู: ูุง ูู ุงููุฑุถูุฉ A3 ุจุงูุชูุตููุ ุฃู ุงุดุฑุญ ูู ูุชุงุฆุฌ ุงููุญุงูุงุฉ...",
                height=80,
                label_visibility="collapsed"
            )
        
        with col2:
            send_btn = st.button("๐ค ุฅุฑุณุงู", use_container_width=True, type="primary")
        
        st.markdown("**๐ก ุฃุณุฆูุฉ ููุชุฑุญุฉ:**")
        suggested_cols = st.columns(3)
        
        suggestions = [
            "ูุง ูู ุงููุฑุถูุงุช ุงูุฃุณุงุณูุฉุ",
            "ุงุดุฑุญ ูุชุงุฆุฌ ุงููุญุงูุงุฉ",
            "ูุชู ูุง ููุณุชุฎุฏู ูุฐุง ุงููููุฐุฌุ"
        ]
        
        for i, suggestion in enumerate(suggestions):
            with suggested_cols[i]:
                if st.button(suggestion, key=f"sug_{i}", use_container_width=True):
                    user_question = suggestion
                    send_btn = True
        
        if send_btn and user_question:
            if st.session_state.client is None:
                st.error("โ ูุฑุฌู ุงูุชุฃูุฏ ูู ุฅุฏุฎุงู ููุชุงุญ API ุตุญูุญ")
            else:
                st.session_state.messages.append({
                    'role': 'user',
                    'content': user_question
                })
                
                with st.spinner("โณ ุฌุงุฑู ุงูุชูููุฑ..."):
                    try:
                        response = chat_with_gemini(
                            st.session_state.client,
                            st.session_state.uploaded_files_content,
                            st.session_state.thinking_level,
                            st.session_state.messages,
                            user_question
                        )
                        
                        st.session_state.messages.append({
                            'role': 'assistant',
                            'content': response
                        })
                        
                        st.rerun()
                    except Exception as e:
                        st.error(f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}")
        
        if st.session_state.messages:
            if st.button("๐๏ธ ูุณุญ ุงููุญุงุฏุซุฉ", type="secondary"):
                st.session_state.messages = []
                st.rerun()

# ==================== ุชุจููุจ ุงูุชุญููู ====================
with tab3:
    st.markdown("### ๐ฅ ุชุญููู ุงูุชูุฑูุฑ")
    
    if st.session_state.analysis_result:
        st.success("โ ุงูุชูุฑูุฑ ุฌุงูุฒ ููุชุญููู!")
        
        st.markdown(f"""
        <div class='info-card'>
            <h4 style='color: #E07B39;'>๐ ูุนูููุงุช ุงูุชูุฑูุฑ</h4>
            <p><strong>ุนุฏุฏ ุงูููุงูุงุช ุงููุญููุฉ:</strong> {len(st.session_state.files_names)}</p>
            <p><strong>ุชุงุฑูุฎ ุงูุชุญููู:</strong> {datetime.now().strftime("%Y-%m-%d %H:%M")}</p>
            <p><strong>ุงูููุงูุงุช:</strong></p>
            <ul>
                {"".join([f"<li>{name}</li>" for name in st.session_state.files_names])}
            </ul>
        </div>
        """, unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        
        with col1:
            try:
                word_bytes = create_word_report(
                    st.session_state.analysis_result,
                    ", ".join(st.session_state.files_names[:2]) + ("..." if len(st.session_state.files_names) > 2 else "")
                )
                
                st.download_button(
                    label="๐ฅ ุชุญููู Word",
                    data=word_bytes,
                    file_name=f"econometrics_report_{datetime.now().strftime('%Y%m%d_%H%M')}.docx",
                    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    use_container_width=True,
                    type="primary"
                )
            except Exception as e:
                st.error(f"ุฎุทุฃ ูู ุฅูุดุงุก Word: {str(e)}")
        
        with col2:
            st.download_button(
                label="๐ ุชุญููู TXT",
                data=st.session_state.analysis_result,
                file_name=f"econometrics_report_{datetime.now().strftime('%Y%m%d_%H%M')}.txt",
                mime="text/plain",
                use_container_width=True
            )
        
        with st.expander("๐๏ธ ูุนุงููุฉ ุงูุชูุฑูุฑ", expanded=False):
            st.markdown(st.session_state.analysis_result)
    
    else:
        st.info("๐ ูู ุจุชุญููู ุงูููุงูุงุช ุฃููุงู ูู ุชุจููุจ 'ุชุญููู ุงูููุงูุงุช' ููุญุตูู ุนูู ุชูุฑูุฑ ูุงุจู ููุชุญููู")
        
        st.markdown("""
        <div class='info-card' style='text-align: center;'>
            <p style='font-size: 48px; margin: 20px 0;'>๐</p>
            <h4 style='color: #D4703A;'>ูุง ููุฌุฏ ุชูุฑูุฑ ุจุนุฏ</h4>
            <p style='color: #888;'>ุงุฑูุน ููุงูุงุชู ููู ุจุชุญููููุง ููุญุตูู ุนูู ุชูุฑูุฑ ุดุงูู</p>
        </div>
        """, unsafe_allow_html=True)

# ==================== Footer ====================
st.markdown("---")
st.markdown("""
<div class='footer'>
    <p style='font-size: 15px; color: #E07B39; font-weight: bold;'>๐ ุงูููุตุฉ ุงูุดุงููุฉ ูุดุฑุญ ุงูููุงูุงุช ุงูุฃุตููุฉ ูุงูุงุฎุชุจุงุฑุงุช ูู ุงูููุงุณ ุงูุงูุชุตุงุฏู</p>
    <p class='designer-name'>ุชุตููู ูุชุทููุฑ: ุฏ. ูุฑูุงู ุฑูุฏุงู | Dr. Marouane Roudan</p>
    <p style='font-size: 11px; color: #999; margin-top: 15px;'>ยฉ 2025</p>
</div>
""", unsafe_allow_html=True)
